# 滴滴车模式指南 - 私有账号认证配置

> 本文档介绍如何配置和使用滴滴车模式（私有账号），包括API Key自动监听、账号切换和故障排除。
>
> **相关文档**: [版本化存储系统](versioned-storage-guide.md) | [存储架构设计](../architecture/storage-architecture.md)

## 🚀 功能概述

我们成功实现了账号类型适配层，支持**公交车**（共享账号）和**滴滴车**（私有账号）两种模式。系统会根据用户选择的账号类型，自动使用对应的域名和API端点。

## ✅ API Key监听问题已修复

**问题**：滴滴车模式下API Key自动切换失效

**原因**：webRequest监听器只在扩展启动时设置一次，无法适应账号类型切换

**解决方案**：

1. ✅ **动态监听器管理**：监听用户偏好变化，自动重新设置webRequest监听器
2. ✅ **精确URL匹配**：只监听当前账号类型对应的API端点
3. ✅ **状态同步**：账号切换时自动清理旧监听器，创建新监听器

**技术实现**：

- 监听 `StorageDomain.USER_PREFERENCE` 变化
- 动态调用 `setupDynamicWebRequestListener()` 重新配置
- 使用当前账号类型的 `apiKeysPattern` 进行监听

现在滴滴车模式的API Key自动转换功能完全正常！🎉

## 🔧 如何切换账号类型

### 方法 1: 通过设置页面（推荐）

1. 点击扩展图标打开popup
2. 点击右下角设置按钮
3. 在"账号版本"下拉菜单中选择：
   - 🚌 **公交车**: 使用 `www.packycode.com`（共享账号）
   - 🚗 **滴滴车**: 使用 `share.packycode.com`（私有账号）

### 方法 2: 开发者工具（开发/测试）

1. 在popup地址后添加 `?dev=true` 参数
2. 会显示额外的开发者工具和账号类型切换器
3. 可以运行适配层测试验证功能

## 🧪 测试滴滴车模式

### 步骤 1: 切换到滴滴车模式

```
设置 -> 账号版本 -> 滴滴车
```

### 步骤 2: 重新加载扩展

- 切换账号类型后，系统会发送通知提醒重新加载扩展
- 在Chrome扩展管理页面点击"重新加载"按钮

### 步骤 3: 清理旧的认证信息

- 扩展会自动清理之前账号类型的认证信息
- 确保新的认证流程从干净状态开始

### 步骤 4: 重新登录

1. 访问 `share.packycode.com` 并登录
2. 扩展会自动检测并获取新的JWT token
3. 查看popup确认认证状态为"JWT"模式

### 步骤 5: 验证功能

- 检查用户预算信息是否正确显示
- 测试购买状态检查是否正常
- 验证所有按钮跳转到正确的域名

## 🔍 开发者测试工具

### 启用开发者模式

在popup URL后添加 `?dev=true` 参数，例如：

```
chrome-extension://[extension-id]/popup.html?dev=true
```

### 可用测试功能

1. **完整测试**: 验证账号类型切换和URL配置
2. **验证配置**: 检查配置结构完整性
3. **权限测试**: 验证域名访问和Cookie权限（🆕 新增）
4. **账号类型切换器**: 直接切换账号类型并查看效果

### 浏览器控制台测试

打开浏览器开发者工具控制台，查看详细的测试日志和调试信息。

## 🏗️ 架构说明

### 核心组件

- **AccountAdapter**: 提供统一的账号配置访问接口
- **AccountAdapterManager**: 管理适配器缓存和动态切换
- **DynamicAPI**: 基于当前账号类型的API调用

### 配置管理

- **单一数据源**: `ACCOUNT_CONFIG_REGISTRY` 统一管理所有配置
- **类型安全**: TypeScript 强制要求配置完整性
- **缓存优化**: 避免重复读取存储，提升性能

### 自动适配

- **Cookie域名**: 根据账号类型从正确域名获取JWT
- **API端点**: 所有API调用自动使用对应域名
- **页面跳转**: 登录/购买按钮跳转到正确页面

## ⚠️ 注意事项

1. **切换后重新加载**: 切换账号类型后必须重新加载扩展
2. **重新登录**: 切换后需要重新登录对应的账号系统
3. **数据隔离**: 不同账号类型的数据是隔离存储的
4. **域名检测**: 系统会自动检测当前访问的域名判断账号类型

## 🐛 故障排除

### 问题: 切换后认证失败

**解决**:

1. 确认已重新加载扩展
2. 清除浏览器缓存和Cookie
3. 重新访问对应域名并登录

### 问题: API调用错误

**解决**:

1. 检查网络连接
2. 确认目标域名服务正常
3. 查看开发者工具控制台错误信息

### 问题: 配置不生效

**解决**:

1. 运行开发者测试工具验证配置
2. 检查存储中的用户偏好设置
3. 刷新适配器缓存

## 📊 测试检查清单

- [ ] 公交车模式可以正常认证和使用
- [ ] 滴滴车模式可以正常认证和使用
- [ ] 账号类型切换功能正常
- [ ] 所有按钮跳转到正确域名
- [ ] API调用使用正确的端点
- [ ] Cookie从正确域名获取
- [ ] 通知功能正常工作
- [ ] 开发者测试工具运行正常

滴滴车模式认证适配层已完全就绪！🎉

---

## 🔗 相关文档

### 技术实现细节

- [版本化存储系统](versioned-storage-guide.md) - 双账号数据隔离架构
- [存储架构设计](../architecture/storage-architecture.md) - StorageManager 技术细节

### 开发者资源

- [贡献指南](../developers/contributing.md) - 参与项目开发
- [编码标准](../developers/coding-standards.md) - 代码规范和最佳实践

### 导航

- [返回功能指南目录](README.md)
- [返回文档中心](../README.md)
